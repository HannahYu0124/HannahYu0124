#I usually run the program at Colab. If you're interested, please check the original version here!
#https://colab.research.google.com/drive/185MVbFEgLIviV27HwB9O6laViFRyulbT?usp=sharing


from spectral import *
import cv2
from matplotlib import pyplot as plt
import numpy as np
from skimage import img_as_ubyte

import os
import glob

# Update the directory path
new_directory = '/content/drive/MyDrive/京大/colab/文件檔/HSI圖像/HY'  # 替換成實際的文件夾路徑!!
os.chdir(new_directory)

dire_name = "/content/drive/MyDrive/京大/colab/文件檔/HSI圖像/HY"  # 替換成實際的小文件夾路徑!!
if os.path.exists(dire_name):

    sample_start = 1  # 替換成樣品開頭數字!!
    ver = 2  # 替換成後面的數字!!

    number = str(sample_start)
    version = '-' + str(ver)

    # 使用 glob 找到特定文件
    files = glob.glob(dire_name + f"/{sample_start}-{ver}*.bil.hdr")

    for file in files:
        print(file)

    # 確保有找到符合條件的文件後再打開影像
    if files:
        img = open_image(files[0])  # 假設只打開第一個符合條件的文件
        print(img)
        print(img.shape)
    else:
        print("No matching files found.")
else:
    print("Directory does not exist.")
img_arr =  np.array(img.load())
img_arr.shape
view = imshow(img[:,:,:])
#選擇RGB!!
area = img[:,:]
img_RGB = get_rgb(area,[240,190,60])
plt.imshow(img_RGB)
img_RGB_ubyte = img_as_ubyte(img_RGB)
img_gray = cv2.cvtColor(img_RGB_ubyte, cv2.COLOR_RGB2GRAY)
img_blur = cv2.blur(img_gray,(9,9))

#選擇區域!!
threshold=75

ret, img_binary= cv2.threshold(img_blur, threshold, 255, cv2.THRESH_BINARY)
contours, hierarchy = cv2.findContours(img_binary, cv2.RETR_CCOMP, cv2.CHAIN_APPROX_SIMPLE)
temp = cv2.drawContours(img_blur, contours,-1, (255,0,0), 2)
#cv2.drawCont4urs(,,*)←ここの数字を変えると果実部分だけが切り出せるように。idx=*も同様。
plt.imshow(temp)
hierarchy
idx = 0
temp = cv2.drawContours(img_blur, contours, idx, (255,0,0), 2)
plt.imshow(temp)
mask = cv2.drawContours(np.zeros_like(img_binary), contours, idx, color=1, thickness=-1)
imshow(mask)
mask = mask.reshape(*mask.shape, 1)
imshow(img_RGB * mask)
#test = img.load()
img_crop = area*mask*10000
imshow(img_crop)
# envi.save_image('test.hdr',img_crop, dtype=np.uint16, interleave="bip",metadata=img.metadata, force=True)
pixel_count = mask.sum()
avr_pixel_val = img_crop.sum(axis=0).sum(axis=0)/pixel_count
avr_pixel_val
import pandas as pd
data1=avr_pixel_val
index=img.bands.centers
data= pd.DataFrame(data1,columns=[number+version], index=index)

#存檔
data.to_csv('/content/drive/MyDrive/京大/colab/文件檔/HSI圖像/HY_csv/H_'+number+version+'.csv')
data
